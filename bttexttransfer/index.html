<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
  <title>テキスト入力</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
  <script src="app.js" defer></script>
</head>

<body>
  <header>
  </header>
  <div class="ad">
    広告領域
  </div>
  <main>
    <div class="main">
      <div>
        <button id="connect">接続</button>
        <button id="disconnect">切断</button>
        <button id="reconnect">再接続</button>
        <div>
          <p>Status: <span id="status">Disconnected</span></p>
    
    
        <h3>Message</h3>
        <textarea id="message" rows="10" cols="100"></textarea>
        <button id="send">送信</button>
                
      </div>  
    </div>
    
  </main>
  <div class="ad">
    広告領域
  </div>

<script src="//cdnjs.cloudflare.com/ajax/libs/d3/4.3.0/d3.min.js"></script>
<script>

window.onload = function() {
  let availability = navigator.bluetooth.getAvailability();
  if(!availability) alert("Bluetooth not available");
};
navigator.bluetooth.addEventListener('onavailabilitychanged', OnAvailabilityChanged);

var bluetoothDevice;
var characteristic;

var TEXT_SERVICE_UUID = 'b07ff626-4b79-0001-89e5-fae40ab7e07f';
var TEXT_CHARACTERISTIC_UUID = 'b07ff626-4b79-0004-89e5-fae40ab7e07f';
//var TEXT_SERVICE_UUID = '0000aaa0-0000-1000-8000-aabbccddeeff'
//var TEXT_CHARACTERISTIC_UUID = '0000aaa2-0000-1000-8000-aabbccddeeff';

var status;

//ボタンイベントリスナー
d3.select("#connect").on("click", connect);
d3.select("#disconnect").on("click", disconnect);
d3.select("#reconnect").on("click", reconnect);
d3.select("#send").on("click", sendMessage);


//デバイスに接続する
function connect() {
  let options = {};

  //options.acceptAllDevices = true;
  options.filters = [
    {services: [TEXT_SERVICE_UUID]}
  ];

  update_status('Connecting...');

  navigator.bluetooth.requestDevice(options)
  .then(device => {
    bluetoothDevice = device;
    console.log("device", device);
    return device.gatt.connect();
  })
  .then(server =>{
    console.log("server", server);
    return server.getPrimaryService(TEXT_SERVICE_UUID);
  })
  .then(service => {
    console.log("service", service);
    return service.getCharacteristic(TEXT_CHARACTERISTIC_UUID)
  })
  .then(chara => {
    console.log("characteristic", chara);
    alert("BLE接続が完了しました。");
    update_status('Connected');
    characteristic = chara;
    
    bluetoothDevice.addEventListener('ongattserverdisconnected', OnGattServerDisconnected);
  })
  .catch(error => {
    console.log(error);
    update_status(error);
  });
}

//メッセージを送信
function sendMessage() {
  if(text === "") return;
  //alert("bluetoothDevice:"+bluetoothDevice+" connected:"+bluetoothDevice.gatt.connected+" characteristic:"+characteristic);
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected || !characteristic) return ;
  var text = document.querySelector("#message").value;
  //  alert(text);
  var arrayBuf = new TextEncoder().encode(text);
  characteristic.writeValueWithoutResponse(arrayBuf);
  clear_text();
}

//BLE切断処理
function disconnect() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected) return ;
  bluetoothDevice.gatt.disconnect();
  alert("BLE接続を切断しました。");
}

function reconnect() {
  if (!bluetoothDevice) return ;
  return new Promise(resolve => {
    return bluetoothDevice.gatt.connect();
  })
  .then(server =>{
    console.log("server", server);
    return server.getPrimaryService(TEXT_SERVICE_UUID);
  })
  .then(service => {
    console.log("service", service);
    return service.getCharacteristic(TEXT_CHARACTERISTIC_UUID)
  })
  .then(chara => {
    console.log("characteristic", chara);
    alert("BLE接続が完了しました。");
    update_status('Connected');
    characteristic = chara;
    
    bluetoothDevice.ongattserverdisconnected = function() {
      update_status("Disconnected (ongattserverdisconnected)");
    };
  });
}

function update_status(state) {
  let elm = document.getElementById('status');
  elm.textContent = state;
}

function clear_text() {
  document.querySelector("#message").value = "";
}

function OnAvailabilityChanged() {
  let availability = Bluetooth.getAvailability();
  if(!availability) {
    alert("Bluetooth not available");
    update_status("Disconnected");
  }
}

function OnGattServerDisconnected() {
  update_status("Disconnected (ongattserverdisconnected).");
  auto_reconnect();
}

</script>
</body>
</html>